# .circleci/config.yml

# Specify the config version - version 2.1 is latest.
version: 2.1
# Specify Terraform version
orbs:
  terraform: circleci/terraform@3.1.0

# Note: These are provided by the ap-fsharp-template-resource-credentials-labs context
# - AZ_SERVICE_PRINCIPAL_APP_ID
# - AZ_SERVICE_PRINCIPAL_APP_PASSWORD
# - RESOURCE_GROUP_NAME

# Note: These are provided by the ap-fsharp-template-resource-credentials-preview context
# - AZ_SERVICE_PRINCIPAL_APP_ID
# - AZ_SERVICE_PRINCIPAL_APP_PASSWORD
# - RESOURCE_GROUP_NAME

# Note: These are provided by the ap-fsharp-template-resource-credentials-cloud context
# - AZ_SERVICE_PRINCIPAL_APP_ID
# - AZ_SERVICE_PRINCIPAL_APP_PASSWORD
# - RESOURCE_GROUP_NAME

# Note: These are provided by the az-resources context
# - AZ_TENANT
# - AZ_SUBSCRIPTION_ID

# Define the jobs for the current project.
jobs:
  build:
    docker:
      - image: mcr.microsoft.com/dotnet/sdk:6.0
    steps:
      - checkout
      - run:
          name: Build
          command: dotnet build
          working_directory: FSharpTemplate
  terraform-single-job-labs:
    executor: terraform/default
    steps:
      - terraform/init
      - terraform/validate
          checkout: true
          requires:
            - terraform/init
      - terraform/import:
          checkout: true
          context:
            - az-resources
            - ap-fsharp-template-resource-credentials-labs
          requires:
            - terraform/validate
          parameters:
            azure_subscription_id:
              default: $AZ_SUBSCRIPTION_ID
              description: Azure Subscription Id
              type: string
            azure_subscription_tenant_id:
              default: $AZ_TENANT
              description: Azure Tenant Id
              type: string
            service_principal_appid:
              default: $AZ_SERVICE_PRINCIPAL_APP_ID
              description: Azure Service Principal App Id
              type: string
            service_principal_password:
              default: $AZ_SERVICE_PRINCIPAL_APP_PASSWORD
              description: Azure Service Principal Password
              type: string
            resource_group_name:
              default: $RESOURCE_GROUP_NAME
              description: Name of the resource group
              type: string
          path: .
      - terraform/plan:
          checkout: true
          context:
            - az-resources
            - ap-fsharp-template-resource-credentials-labs
          requires:
            - terraform/import
          parameters:
            azure_subscription_id:
              default: $AZ_SUBSCRIPTION_ID
              description: Azure Subscription Id
              type: string
            azure_subscription_tenant_id:
              default: $AZ_TENANT
              description: Azure Tenant Id
              type: string
            service_principal_appid:
              default: $AZ_SERVICE_PRINCIPAL_APP_ID
              description: Azure Service Principal App Id
              type: string
            service_principal_password:
              default: $AZ_SERVICE_PRINCIPAL_APP_PASSWORD
              description: Azure Service Principal Password
              type: string
          path: .
      - terraform/apply:
          checkout: true
          requires:
            - terraform/plan
          parameters:
            azure_subscription_id:
              default: $AZ_SUBSCRIPTION_ID
              description: Azure Subscription Id
              type: string
            azure_subscription_tenant_id:
              default: $AZ_TENANT
              description: Azure Tenant Id
              type: string
            service_principal_appid:
              default: $AZ_SERVICE_PRINCIPAL_APP_ID
              description: Azure Service Principal App Id
              type: string
            service_principal_password:
              default: $AZ_SERVICE_PRINCIPAL_APP_PASSWORD
              description: Azure Service Principal Password
              type: string
          path: .
    working_directory: ~/FSharpTemplate/Terraform

workflows:
  deploy_infrastructure:
    when:
      - equal: false
    jobs:
      - build
      - terraform-single-job:
          requires:
            - build